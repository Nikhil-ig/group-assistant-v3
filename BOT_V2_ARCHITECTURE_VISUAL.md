# ğŸ—ï¸ BOT V2 - ARCHITECTURE & VISUAL GUIDE

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TELEGRAM USERS                             â”‚
â”‚                    (Admins & Regular Users)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Telegram Bot API      â”‚
                    â”‚   (aiogram library)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                               â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚                                                           â”‚
    â”‚         ğŸ¤– TELEGRAM BOT V2 (bot_v2.py)                 â”‚
    â”‚                                                           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚  Command Handlers                                â”‚   â”‚
    â”‚  â”‚  â€¢ /start    â†’ Welcome message                   â”‚   â”‚
    â”‚  â”‚  â€¢ /help     â†’ Commands help                     â”‚   â”‚
    â”‚  â”‚  â€¢ /settings â†’ Admin panel                       â”‚   â”‚
    â”‚  â”‚  â€¢ /status   â†’ Bot status                        â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                          â†“                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚  State Management                                â”‚   â”‚
    â”‚  â”‚  â€¢ Check admin status                            â”‚   â”‚
    â”‚  â”‚  â€¢ Get user data                                 â”‚   â”‚
    â”‚  â”‚  â€¢ Cache management                              â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                          â†“                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚  Message Formatters                              â”‚   â”‚
    â”‚  â”‚  â€¢ format_admin_panel_message()                  â”‚   â”‚
    â”‚  â”‚  â€¢ format_user_action_message()                  â”‚   â”‚
    â”‚  â”‚  â€¢ format_success_message()                      â”‚   â”‚
    â”‚  â”‚  â€¢ format_error_message()                        â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                          â†“                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚  Keyboard Builders                               â”‚   â”‚
    â”‚  â”‚  â€¢ build_admin_toggle_keyboard()                 â”‚   â”‚
    â”‚  â”‚  â€¢ Smart state detection                         â”‚   â”‚
    â”‚  â”‚  â€¢ Callback data encoding                        â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                          â†“                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚  Callback Handlers                               â”‚   â”‚
    â”‚  â”‚  â€¢ handle_action_callback()                      â”‚   â”‚
    â”‚  â”‚  â€¢ Button click processing                       â”‚   â”‚
    â”‚  â”‚  â€¢ State updates                                 â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                          â†“                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚  Cache System                                    â”‚   â”‚
    â”‚  â”‚  â€¢ USER_STATS_CACHE (30s TTL)                   â”‚   â”‚
    â”‚  â”‚  â€¢ CALLBACK_DATA_CACHE (encoded IDs)            â”‚   â”‚
    â”‚  â”‚  â€¢ Auto-cleanup (10000+ entries)                â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                          â†“                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  APIv2ClientV2 Class    â”‚
                    â”‚  (HTTP Client)          â”‚
                    â”‚  â€¢ Connection pooling   â”‚
                    â”‚  â€¢ Bearer auth          â”‚
                    â”‚  â€¢ Error handling       â”‚
                    â”‚  â€¢ 15s timeout          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                               â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚                   â”‚    â”‚                                 â”‚
    â”‚   API V2 Endpoints     â”‚   Operation Types              â”‚
    â”‚   (HTTP REST)          â”‚                                 â”‚
    â”‚                        â”‚  â€¢ execute_action()             â”‚
    â”‚   âœ… /health           â”‚  â€¢ get_user_status()            â”‚
    â”‚   âœ… /enforcement/*    â”‚  â€¢ get_group_settings()         â”‚
    â”‚   âœ… /users/*/status   â”‚  â€¢ update_user_action_state()   â”‚
    â”‚   âœ… /logs/actions     â”‚  â€¢ log_action()                 â”‚
    â”‚                        â”‚                                 â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                             â”‚
         â”‚   ğŸ—„ï¸  API V2 Backend        â”‚
         â”‚   (Centralized)             â”‚
         â”‚                             â”‚
         â”‚   Database Layer            â”‚
         â”‚   â€¢ User states             â”‚
         â”‚   â€¢ Action history          â”‚
         â”‚   â€¢ Group settings          â”‚
         â”‚   â€¢ Audit logs              â”‚
         â”‚                             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

### Command Flow: `/settings @user`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User types:     â”‚
â”‚ /settings @john â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Parse command arguments     â”‚
    â”‚ â€¢ Extract @username         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Verify admin status          â”‚
    â”‚ â€¢ Check member privileges    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Get user info               â”‚
    â”‚ â€¢ From @username or ID      â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ API: get_user_status()      â”‚
    â”‚ â€¢ HTTP call to API V2       â”‚
    â”‚ â€¢ Get current state         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Format message              â”‚
    â”‚ â€¢ Beautiful UI              â”‚
    â”‚ â€¢ State indicators          â”‚
    â”‚ â€¢ User mention              â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Build keyboard              â”‚
    â”‚ â€¢ Smart buttons             â”‚
    â”‚ â€¢ State-aware               â”‚
    â”‚ â€¢ Callback encoding         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Send admin panel            â”‚
    â”‚ â€¢ Reply to original message â”‚
    â”‚ â€¢ With keyboard buttons     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User sees:                  â”‚
    â”‚ Beautiful admin panel       â”‚
    â”‚ with toggle buttons         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Button Click Flow: User clicks "Mute"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks "ğŸ”‡ Mute" button â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Telegram sends callback_query â”‚
    â”‚ â€¢ Button callback_data        â”‚
    â”‚ â€¢ Encoded: "cb_123"           â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ handle_action_callback()       â”‚
    â”‚ â€¢ Decode callback_data        â”‚
    â”‚ â€¢ Extract: action, user, groupâ”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Verify admin status           â”‚
    â”‚ â€¢ Check permissions           â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Show "â³ Processing..."        â”‚
    â”‚ â€¢ User feedback               â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ API: execute_action()         â”‚
    â”‚ â€¢ POST /enforcement/mute      â”‚
    â”‚ â€¢ user_id, group_id, admin_id â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ API: log_action()             â”‚
    â”‚ â€¢ Record in audit trail       â”‚
    â”‚ â€¢ Store timestamp             â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Refresh user status           â”‚
    â”‚ â€¢ Call API get_user_status()  â”‚
    â”‚ â€¢ Get new state               â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Rebuild keyboard              â”‚
    â”‚ â€¢ Show new state              â”‚
    â”‚ â€¢ Now: "ğŸ”Š Unmute" button    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Update panel message          â”‚
    â”‚ â€¢ Edit existing message       â”‚
    â”‚ â€¢ Show new buttons            â”‚
    â”‚ â€¢ Show success confirmation   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Show "âœ… Done!" notification  â”‚
    â”‚ â€¢ User sees result            â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User can:                     â”‚
    â”‚ â€¢ Click more buttons          â”‚
    â”‚ â€¢ Click "âŒ Close"            â”‚
    â”‚ â€¢ Panel stays open            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Interaction

### Message Formatter Flow

```
Target User â†’ Get display name â†’ Create mention link
        â†“
        Get current state
        â†“
        Format admin panel
        â†“
        Add state indicators (ğŸŸ¢ ğŸ”´)
        â†“
        Add button descriptions
        â†“
        Beautiful formatted message
```

### Keyboard Builder Flow

```
Current states â†’ Check each state
        â†“
        Determine opposite action
        â†“
        Create button with label
        â†“
        Encode callback data (cb_N)
        â†“
        Add button to keyboard
        â†“
        Return InlineKeyboardMarkup
```

### Cache System Flow

```
Request user stats (user_id, group_id)
        â†“
        Check cache
        â†“
        Not found? â†’ Call API
                        â†“
                        Store in cache with TTL
                        â†“
                        Return data
        â†“
        Found? â†’ Check expiration
                        â†“
                        Expired? â†’ Delete & call API
                        â†“
                        Valid? â†’ Return cached data
```

---

## State Transition Diagram

### User Mute States

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Not Muted         â”‚
    â”‚  âŒ INACTIVE        â”‚
    â”‚  Show: Mute button  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Click "ğŸ”‡ Mute"
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Being Muted        â”‚
    â”‚  â³ PROCESSING      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ API processes
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Muted            â”‚
    â”‚  âœ… ACTIVE         â”‚
    â”‚  Show: Unmute btn   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Click "ğŸ”Š Unmute"
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Being Unmuted      â”‚
    â”‚  â³ PROCESSING      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ API processes
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Not Muted         â”‚
    â”‚  âŒ INACTIVE        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cache Structure

```
USER_STATS_CACHE = {
    (user_id_1, group_id_1): (
        {
            "user_id": 123,
            "is_muted": True,
            "is_banned": False,
            "has_warnings": 2,
            ...
        },
        expires_timestamp  # time.time() + 30
    ),
    
    (user_id_2, group_id_1): (
        {...},
        expires_timestamp
    ),
    ...
}

CALLBACK_DATA_CACHE = {
    "cb_0": {
        "action": "mute",
        "user_id": 123,
        "group_id": 456,
        "timestamp": 1705515045.123
    },
    
    "cb_1": {
        "action": "ban",
        "user_id": 789,
        "group_id": 456,
        "timestamp": 1705515046.234
    },
    ...
}
```

---

## API Request/Response Flow

### Execute Action Request

```
Bot â†’ API

POST /api/v2/groups/{group_id}/enforcement/{action_type}
Headers: Authorization: Bearer {api_key}
Body: {
    "action_type": "mute",
    "user_id": 123456789,
    "group_id": 987654321,
    "admin_id": 111111111,
    "duration": null,
    "reason": "Spamming",
    "timestamp": "2026-01-17T14:30:45.123456"
}

API â†’ Bot

200 OK
{
    "success": true,
    "data": {
        "user_id": 123456789,
        "action": "mute",
        "timestamp": "2026-01-17T14:30:45.123456"
    },
    "message": "âœ… Mute executed"
}
```

### Get User Status Request

```
Bot â†’ API

GET /api/v2/groups/{group_id}/users/{user_id}/status
Headers: Authorization: Bearer {api_key}

API â†’ Bot

200 OK
{
    "user_id": 123456789,
    "group_id": 987654321,
    "is_muted": true,
    "is_banned": false,
    "has_warnings": 3,
    "is_restricted": false,
    "is_locked_down": false,
    "night_mode_enabled": false,
    "last_action": "2026-01-17T14:30:45",
    "active_actions": ["mute"]
}
```

---

## Performance Characteristics

### Connection Lifecycle

```
First Request:
TCP handshake        â†’ ~30ms
SSL/TLS negotiation  â†’ ~50ms
API request          â†’ ~100ms
Total               â†’ ~180ms

Subsequent Requests (reused connection):
API request only     â†’ ~100ms
Total               â†’ ~100ms

Improvement:        80% faster!
```

### Cache Hit Pattern

```
Cache Request Time: < 1ms
API Request Time:   100ms+

1000 requests:
- With cache:    1ms (instant)
- Without cache: 100s (100 seconds)
Speedup:         100x faster!
```

---

## Error Handling Flow

```
Try to execute action
    â†“
Success?
    â”œâ”€ YES â†’ Return result
    â”‚          â†“
    â”‚        Update UI
    â”‚        Log success
    â”‚
    â””â”€ NO â†’ Catch exception
               â†“
            Log error
            â†“
            Return sensible default
            â†“
            Show user-friendly message
            â†“
            Continue normally
```

---

## Concurrency Model

### Multiple Requests

```
Request 1 â†’ API call (non-blocking) â”
Request 2 â†’ API call (non-blocking) â”œâ”€ Run in parallel!
Request 3 â†’ API call (non-blocking) â”¤
Request 4 â†’ API call (non-blocking) â”¤
Request 5 â†’ API call (non-blocking) â”˜

All complete at same time (async)
Instead of waiting sequentially
```

### Timeline

```
Sequential (Old Way):
Req1: 100ms
Req2: 100ms
Req3: 100ms
Total: 300ms

Parallel (New Way):
Req1: â–ˆâ–ˆâ–ˆâ–ˆ
Req2: â–ˆâ–ˆâ–ˆâ–ˆ
Req3: â–ˆâ–ˆâ–ˆâ–ˆ
Total: 100ms (all in parallel)
```

---

## Security Architecture

```
User Action
    â†“
Verify authentication
    â”œâ”€ Check admin status
    â”œâ”€ Verify group membership
    â”œâ”€ Validate permissions
    â”‚
    â””â”€ Not authorized? â†’ Reject âœ—
    
Valid Admin
    â†“
Validate input
    â”œâ”€ Check user ID format
    â”œâ”€ Check group ID format
    â”œâ”€ Validate action type
    â”‚
    â””â”€ Invalid? â†’ Reject âœ—
    
Valid Request
    â†“
Sanitize data
    â”œâ”€ HTML escape strings
    â”œâ”€ Remove sensitive info
    â”œâ”€ Create safe message
    â”‚
    â””â”€ Execute action âœ“
    
Log Action
    â”œâ”€ Who: admin_id
    â”œâ”€ What: action type
    â”œâ”€ When: timestamp
    â”œâ”€ Where: group_id
    â””â”€ Why: reason/details
```

---

## Deployment Architecture

### Single Instance

```
Telegram Bot
    â†“
Bot V2 (bot_v2.py)
    â†“
API V2
    â†“
Database
```

### Multiple Instances (Load Balanced)

```
                    Telegram
                        â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                   â”‚
            Bot1                Bot2
         (bot_v2.py)         (bot_v2.py)
              â”‚                   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                    API V2 (shared)
                        â†“
                   Database
```

---

## File Structure & Modules

```
bot/
â”œâ”€â”€ bot_v2.py
â”‚   â”œâ”€â”€ Imports & Setup
â”‚   â”œâ”€â”€ APIv2ClientV2 class
â”‚   â”‚   â”œâ”€â”€ __init__()
â”‚   â”‚   â”œâ”€â”€ health_check()
â”‚   â”‚   â”œâ”€â”€ execute_action()
â”‚   â”‚   â”œâ”€â”€ get_user_status()
â”‚   â”‚   â”œâ”€â”€ log_action()
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ Enums (ActionState, ToggleAction)
â”‚   â”œâ”€â”€ Cache Management
â”‚   â”‚   â”œâ”€â”€ encode_callback_data()
â”‚   â”‚   â”œâ”€â”€ decode_callback_data()
â”‚   â”‚   â”œâ”€â”€ cache_user_stats()
â”‚   â”‚   â””â”€â”€ get_cached_user_stats()
â”‚   â”œâ”€â”€ Message Formatters
â”‚   â”‚   â”œâ”€â”€ format_admin_panel_message()
â”‚   â”‚   â”œâ”€â”€ format_user_action_message()
â”‚   â”‚   â”œâ”€â”€ format_success_message()
â”‚   â”‚   â””â”€â”€ format_error_message()
â”‚   â”œâ”€â”€ Keyboard Builders
â”‚   â”‚   â””â”€â”€ build_admin_toggle_keyboard()
â”‚   â”œâ”€â”€ Helper Functions
â”‚   â”‚   â”œâ”€â”€ get_user_display_name()
â”‚   â”‚   â”œâ”€â”€ check_is_admin()
â”‚   â”‚   â””â”€â”€ get_user_info_from_reply()
â”‚   â”œâ”€â”€ Command Handlers
â”‚   â”‚   â”œâ”€â”€ cmd_start()
â”‚   â”‚   â”œâ”€â”€ cmd_help()
â”‚   â”‚   â”œâ”€â”€ cmd_status()
â”‚   â”‚   â””â”€â”€ cmd_settings()
â”‚   â”œâ”€â”€ Callback Handlers
â”‚   â”‚   â””â”€â”€ handle_action_callback()
â”‚   â”œâ”€â”€ Bot Lifecycle
â”‚   â”‚   â”œâ”€â”€ on_startup()
â”‚   â”‚   â”œâ”€â”€ on_shutdown()
â”‚   â”‚   â””â”€â”€ main()
â”‚   â””â”€â”€ Run
â”‚
â”œâ”€â”€ .env (configuration)
â””â”€â”€ requirements.txt
```

---

## Message Template Examples

### Admin Panel Template

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    ğŸ›ï¸ ADVANCED ADMIN CONTROL PANEL
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ User: {mention}
ğŸ†” ID: {user_id}
ğŸ“ Group: {group_id}

{status_indicators}

ğŸ’¡ Use the buttons below to toggle actions
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### Action Success Template

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    âœ… SUCCESS
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ¨ Action: {ACTION}
ğŸ‘¤ User: {mention}
ğŸ“ {details}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

**Architecture Version:** 2.0
**Last Updated:** 2026-01-17
**Complexity:** â­â­â­â­â­ Expert
